<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual USB Storage</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #16a34a;
            --success-dark: #15803d;
            --warning: #d97706;
            --warning-dark: #b45309;
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --background: #f3f4f6;
            --surface: #ffffff;
            --text: #111827;
            --text-secondary: #6b7280;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: var(--surface);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(-100%);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 30;
        }

        .sidebar.open {
            transform: translateX(0);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .sidebar-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 32px;
            width: 32px;
            transition: background 0.3s ease, transform 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .sidebar-toggle span {
            width: 20px;
            height: 2px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }

        .sidebar.open .sidebar-toggle span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .sidebar.open .sidebar-toggle span:nth-child(2) {
            opacity: 0;
            transform: translateX(-10px);
        }

        .sidebar.open .sidebar-toggle span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .file-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background: var(--surface);
            border: 1px solid transparent;
        }

        .file-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-image: linear-gradient(to right, var(--primary), var(--success)) 1;
        }

        .auth-card {
            background: var(--surface);
            border: 1px solid #e5e7eb;
            animation: slideIn 0.5s ease-in;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-field {
            transition: all 0.3s ease;
            background-color: var(--surface);
            color: var(--text);
        }

        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
        }

        .password-wrapper svg {
            color: var(--text-secondary);
        }

        .password-wrapper svg:hover {
            color: var(--text);
        }

        .error-message {
            transition: opacity 0.3s ease;
        }

        button {
            touch-action: manipulation; /* Disable double-tap zoom */
        }

        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--success);
            transition: width 0.3s ease;
        }

        @media (max-width: 640px) {
            .sidebar { width: 80vw; }
            .auth-card {
                padding: 1.5rem;
                margin: 1rem;
            }
            .input-field {
                font-size: 1rem; /* Larger text for mobile */
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header id="header" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 shadow-md sticky top-0 z-10 hidden">
        <div class="container mx-auto flex justify-between items-center flex-col sm:flex-row gap-4">
            <div class="flex items-center gap-4">
                <button id="sidebarToggle" class="sidebar-toggle hidden">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1 class="text-2xl font-bold">Virtual USB Storage</h1>
            </div>
        </div>
    </header>

    <div id="sidebar" class="sidebar">
        <div class="p-6 flex flex-col h-full">
            <h2 class="text-xl font-semibold mb-6">Menu</h2>
            <div id="sidebarUserInfo" class="flex flex-col gap-4">
                <span id="sidebarLoggedInUser" class="font-semibold text-base bg-gray-100 p-3 rounded-md"></span>
                <div id="currentPath" class="text-sm font-semibold bg-gray-100 p-3 rounded-md"></div>
                <button onclick="logout()" class="btn-danger bg-gradient-to-r from-red-600 to-red-800 text-white px-4 py-2 rounded-md hover:from-red-800 hover:to-red-600 transition-all">Logout</button>
            </div>
            <div class="mt-auto text-sm text-gray-500">
                <p>Version 1.0.0</p>
            </div>
        </div>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <main class="flex-grow container mx-auto p-6">
        <div id="authSection" class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
            <div id="loginForm" class="auth-card flex flex-col gap-6 p-6 sm:p-8 w-full max-w-md">
                <div class="text-center">
                    <h2 class="text-2xl font-bold">Welcome Back</h2>
                    <p class="text-gray-500 text-sm mt-2">Sign in to access your Virtual USB Storage</p>
                </div>
                <div>
                    <label for="username" class="block text-sm font-semibold mb-2">Username</label>
                    <input 
                        id="username" 
                        type="text" 
                        autocapitalize="none" 
                        autocorrect="off" 
                        class="input-field w-full p-3 border rounded-md" 
                        placeholder="Enter username" 
                        aria-required="true"
                    >
                    <p id="loginUsernameError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div>
                    <label for="password" class="block text-sm font-semibold mb-2">Password</label>
                    <div class="password-wrapper relative">
                        <input 
                            id="password" 
                            type="password" 
                            class="input-field w-full p-3 border rounded-md" 
                            placeholder="Enter password" 
                            aria-required="true"
                        >
                        <button 
                            type="button" 
                            class="show-password absolute right-3 top-3 p-2" 
                            onclick="togglePassword('password')" 
                            aria-label="Toggle password visibility"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <p id="loginPasswordError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button 
                        onclick="login()" 
                        class="btn-success bg-gradient-to-r from-green-600 to-green-800 text-white px-4 py-3 rounded-md hover:from-green-800 hover:to-green-600 transition-all text-base min-h-[48px]" 
                        aria-label="Sign in"
                    >
                        Login
                    </button>
                    <button 
                        onclick="showRegister()" 
                        class="btn-warning bg-gradient-to-r from-yellow-600 to-yellow-800 text-white px-4 py-3 rounded-md hover:from-yellow-800 hover:to-yellow-600 transition-all text-base min-h-[48px]" 
                        aria-label="Go to registration"
                    >
                        Register
                    </button>
                </div>
            </div>
            <div id="registerForm" class="auth-card flex flex-col gap-6 p-6 sm:p-8 w-full max-w-md hidden">
                <div class="text-center">
                    <h2 class="text-2xl font-bold">Create Account</h2>
                    <p class="text-gray-500 text-sm mt-2">Join Virtual USB Storage today</p>
                </div>
                <div>
                    <label for="regUsername" class="block text-sm font-semibold mb-2">New Username</label>
                    <input 
                        id="regUsername" 
                        type="text" 
                        autocapitalize="none" 
                        autocorrect="off" 
                        class="input-field w-full p-3 border rounded-md" 
                        placeholder="Choose a username" 
                        aria-required="true"
                    >
                    <p id="regUsernameError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div>
                    <label for="regPassword" class="block text-sm font-semibold mb-2">New Password</label>
                    <div class="password-wrapper relative">
                        <input 
                            id="regPassword" 
                            type="password" 
                            class="input-field w-full p-3 border rounded-md" 
                            placeholder="Choose a password" 
                            aria-required="true"
                        >
                        <button 
                            type="button" 
                            class="show-password absolute right-3 top-3 p-2" 
                            onclick="togglePassword('regPassword')" 
                            aria-label="Toggle password visibility"
                        >
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <p id="regPasswordError" class="error-message text-red-600 text-sm mt-1 hidden"></p>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button 
                        onclick="register()" 
                        class="btn-success bg-gradient-to-r from-green-600 to-green-800 text-white px-4 py-3 rounded-md hover:from-green-800 hover:to-green-600 transition-all text-base min-h-[48px]" 
                        aria-label="Create account"
                    >
                        Register
                    </button>
                    <button 
                        onclick="showLogin()" 
                        class="btn-danger bg-gradient-to-r from-red-600 to-red-800 text-white px-4 py-3 rounded-md hover:from-red-800 hover:to-red-600 transition-all text-base min-h-[48px]" 
                        aria-label="Cancel registration"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <div id="fileControls" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <div class="flex-grow">
                    <label for="folderName" class="block text-sm font-semibold mb-1">Folder Name</label>
                    <input id="folderName" class="input-field w-full p-3 border rounded-md" placeholder="Enter folder name">
                </div>
                <button onclick="createFolder()" class="btn-primary bg-gradient-to-r from-blue-600 to-blue-800 text-white px-4 py-2 rounded-md hover:from-blue-800 hover:to-blue-600 transition-all mt-4 sm:mt-0">Create Folder</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-grow">
                    <label for="fileInput" class="block text-sm font-semibold mb-1">Upload Files</label>
                    <input type="file" id="fileInput" multiple class="input-field w-full p-3 border rounded-md">
                </div>
                <button onclick="saveFiles()" class="btn-success bg-gradient-to-r from-green-600 to-green-800 text-white px-4 py-2 rounded-md hover:from-green-800 hover:to-green-600 transition-all mt-4 sm:mt-0">Save Files</button>
            </div>
            <div id="uploadProgress" class="hidden mt-4">
                <p class="text-sm font-semibold mb-2">Uploading...</p>
                <div class="progress-bar">
                    <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-500 mt-2"></p>
            </div>
        </div>
        <div id="fileList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </main>
    <footer class="bg-gray-900 text-white text-center p-4 text-sm">
        <p>&copy; 2025 Virtual USB Storage</p>
    </footer>

    <script>
        let currentPath = '/';
        let isLoggedIn = false;
        let currentUser = '';

        // Utility to hash passwords using SHA-256
        async function hashPassword(password) {
            const msgBuffer = new TextEncoder().encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Compress image using Canvas
        async function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (!file.type.startsWith('image/')) return resolve(file);
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(
                            (blob) => {
                                if (!blob) return reject(new Error('Failed to compress image'));
                                resolve(new File([blob], file.name, { type: file.type }));
                            },
                            file.type,
                            quality
                        );
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                };
                reader.onerror = () => reject(new Error('Failed to read image'));
                reader.readAsDataURL(file);
            });
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Show errors inline
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border-l-4 border-red-600 text-red-700 p-4 mb-4 rounded';
            errorDiv.textContent = message;
            const authSection = document.getElementById('authSection');
            authSection.insertBefore(errorDiv, authSection.firstChild);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Real-time input validation
        function setupInputValidation() {
            const inputs = [
                { id: 'username', errorId: 'loginUsernameError', validate: validateUsername },
                { id: 'password', errorId: 'loginPasswordError', validate: validatePassword },
                { id: 'regUsername', errorId: 'regUsernameError', validate: validateUsername },
                { id: 'regPassword', errorId: 'regPasswordError', validate: validatePassword }
            ];

            inputs.forEach(({ id, errorId, validate }) => {
                const input = document.getElementById(id);
                const error = document.getElementById(errorId);
                input.addEventListener('input', () => {
                    const value = input.value.trim();
                    const errorMessage = validate(value);
                    error.textContent = errorMessage || '';
                    error.classList.toggle('hidden', !errorMessage);
                });
            });
        }

        function validateUsername(username) {
            if (!username) return 'Username is required';
            if (!/^[a-zA-Z0-9_-]{3,20}$/.test(username)) {
                return 'Username must be 3-20 alphanumeric characters, underscores, or hyphens';
            }
            return '';
        }

        function validatePassword(password) {
            if (!password) return 'Password is required';
            if (password.length < 6) return 'Password must be at least 6 characters';
            return '';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function createSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');
            const header = document.getElementById('header');
            if (!sidebar || !toggleButton || !overlay || !header) return;
            header.classList.remove('hidden');
            toggleButton.classList.remove('hidden');
            toggleButton.onclick = toggleSidebar;
            overlay.addEventListener('click', toggleSidebar);
        }

        function removeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');
            const header = document.getElementById('header');
            if (sidebar) sidebar.classList.remove('open');
            if (toggleButton) toggleButton.classList.add('hidden');
            if (overlay) overlay.classList.remove('active');
            if (header) header.classList.add('hidden');
        }

        function checkAuthState() {
            currentUser = localStorage.getItem('currentUser') || '';
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const fileControls = document.getElementById('fileControls');
            const authSection = document.getElementById('authSection');

            if (currentUser) {
                isLoggedIn = true;
                createSidebar();
                const sidebarUserInfo = document.getElementById('sidebarUserInfo');
                const sidebarLoggedInUser = document.getElementById('sidebarLoggedInUser');
                if (sidebarUserInfo && sidebarLoggedInUser) {
                    sidebarLoggedInUser.textContent = `Welcome, ${currentUser}`;
                    sidebarUserInfo.classList.remove('hidden');
                }
                loginForm.classList.add('hidden');
                registerForm.classList.add('hidden');
                fileControls.classList.remove('hidden');
                authSection.classList.add('hidden');
                currentPath = `/${currentUser}/`;
                updatePathDisplay();
            } else {
                isLoggedIn = false;
                removeSidebar();
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                fileControls.classList.add('hidden');
                authSection.classList.remove('hidden');
                currentPath = '/';
            }
        }

        function updatePathDisplay() {
            const pathDisplay = document.getElementById('currentPath');
            if (pathDisplay && isLoggedIn) {
                const displayPath = currentPath.replace(`/${currentUser}/`, '/');
                pathDisplay.innerHTML = `Current Path: <span class="font-semibold">${displayPath === '/' ? '/root' : displayPath}</span>`;
            }
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field.nextElementSibling.querySelector('svg');
            if (field.type === 'password') {
                field.type = 'text';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z M1 12a11 11 0 0110 0 M1 12a11 11 0 0010 0" />';
            } else {
                field.type = 'password';
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
            }
        }

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const usernameError = document.getElementById('loginUsernameError');
            const passwordError = document.getElementById('loginPasswordError');
            usernameError.classList.add('hidden');
            passwordError.classList.add('hidden');

            const usernameErrorMsg = validateUsername(username);
            const passwordErrorMsg = validatePassword(password);
            if (usernameErrorMsg) {
                usernameError.textContent = usernameErrorMsg;
                usernameError.classList.remove('hidden');
                return;
            }
            if (passwordErrorMsg) {
                passwordError.textContent = passwordErrorMsg;
                passwordError.classList.remove('hidden');
                return;
            }

            try {
                const users = JSON.parse(localStorage.getItem('virtual_usb_users') || '{}');
                const hashedPassword = await hashPassword(password);
                if (users[username] && users[username].password === hashedPassword) {
                    localStorage.setItem('currentUser', username);
                    checkAuthState();
                    listFiles();
                } else {
                    passwordError.textContent = 'Invalid username or password';
                    passwordError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error during login:', error.name, error.message);
                showError('Error during login: ' + error.message);
            }
        }

        async function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const usernameError = document.getElementById('regUsernameError');
            const passwordError = document.getElementById('regPasswordError');
            usernameError.classList.add('hidden');
            passwordError.classList.add('hidden');

            const usernameErrorMsg = validateUsername(username);
            const passwordErrorMsg = validatePassword(password);
            if (usernameErrorMsg) {
                usernameError.textContent = usernameErrorMsg;
                usernameError.classList.remove('hidden');
                return;
            }
            if (passwordErrorMsg) {
                passwordError.textContent = passwordErrorMsg;
                passwordError.classList.remove('hidden');
                return;
            }

            try {
                let users = JSON.parse(localStorage.getItem('virtual_usb_users') || '{}');
                if (users[username]) {
                    usernameError.textContent = 'Username already exists';
                    usernameError.classList.remove('hidden');
                    return;
                }

                const hashedPassword = await hashPassword(password);
                users[username] = { username, password: hashedPassword };
                localStorage.setItem('virtual_usb_users', JSON.stringify(users));

                // Create root folder for the user
                let files = JSON.parse(localStorage.getItem(`user_${username}_files`) || '{}');
                const rootPath = `/${username}/`;
                files[rootPath] = { path: rootPath, folder: '/', type: 'directory', data: null };
                localStorage.setItem(`user_${username}_files`, JSON.stringify(files));

                localStorage.setItem('currentUser', username);
                checkAuthState();
                listFiles();
            } catch (error) {
                console.error('Error during registration:', error.name, error.message);
                if (error.name === 'QuotaExceededError') {
                    showError('Storage quota exceeded. Please clear some data and try again.');
                } else {
                    showError('Error during registration: ' + error.message);
                }
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            checkAuthState();
            listFiles();
            const sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.classList.remove('open');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) sidebarOverlay.classList.remove('active');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function createFolder() {
            if (!isLoggedIn) {
                showError('Please log in to create folders');
                return;
            }
            const folderName = document.getElementById('folderName').value.trim();
            if (!folderName) {
                showError('Please enter a folder name');
                return;
            }
            if (!/^[a-zA-Z0-9_-]{1,50}$/.test(folderName)) {
                showError('Folder name must be 1-50 alphanumeric characters, underscores, or hyphens');
                return;
            }
            const folderPath = currentPath + folderName + '/';
            try {
                let files = JSON.parse(localStorage.getItem(`user_${currentUser}_files`) || '{}');
                if (files[folderPath]) {
                    showError('Folder already exists');
                    return;
                }
                files[folderPath] = { path: folderPath, folder: currentPath, type: 'directory', data: null };
                localStorage.setItem(`user_${currentUser}_files`, JSON.stringify(files));
                listFiles();
                document.getElementById('folderName').value = '';
            } catch (error) {
                console.error('Error creating folder:', error.name, error.message);
                if (error.name === 'QuotaExceededError') {
                    showError('Storage quota exceeded. Please clear some data and try again.');
                } else {
                    showError('Error creating folder: ' + error.message);
                }
            }
        }

        async function saveFiles() {
            if (!isLoggedIn) {
                showError('Please log in to save files');
                return;
            }
            const input = document.getElementById('fileInput');
            const files = Array.from(input.files);
            if (files.length === 0) {
                showError('Please select at least one file');
                return;
            }

            const progressBar = document.getElementById('uploadProgress');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            progressBar.classList.remove('hidden');

            try {
                let storedFiles = JSON.parse(localStorage.getItem(`user_${currentUser}_files`) || '{}');
                let processed = 0;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const filePath = currentPath + file.name;
                    if (storedFiles[filePath]) {
                        showError(`File ${file.name} already exists`);
                        continue;
                    }

                    // Compress images
                    const processedFile = file.type.startsWith('image/') ? await compressImage(file) : file;

                    // Update progress
                    processed++;
                    const progress = (processed / files.length) * 100;
                    progressBarFill.style.width = `${progress}%`;
                    progressText.textContent = `Processing ${processed} of ${files.length} files`;

                    // Read file as Data URL
                    const reader = new FileReader();
                    await new Promise((resolve, reject) => {
                        reader.onload = () => {
                            storedFiles[filePath] = {
                                path: filePath,
                                folder: currentPath,
                                type: file.type || 'application/octet-stream',
                                data: reader.result,
                                size: file.size
                            };
                            resolve();
                        };
                        reader.onerror = () => reject(new Error(`Failed to read file ${file.name}`));
                        reader.readAsDataURL(processedFile);
                    });
                }

                localStorage.setItem(`user_${currentUser}_files`, JSON.stringify(storedFiles));
                listFiles();
                input.value = '';
                progressBar.classList.add('hidden');
                progressText.textContent = '';
                progressBarFill.style.width = '0%';
                showError(`Successfully uploaded ${processed} file(s)`);
            } catch (error) {
                console.error('Error saving files:', error.name, error.message);
                progressBar.classList.add('hidden');
                if (error.name === 'QuotaExceededError') {
                    showError('Storage quota exceeded. Please clear some data and try again.');
                } else {
                    showError('Error saving files: ' + error.message);
                }
            }
        }

        function downloadFile(path, name) {
            try {
                const files = JSON.parse(localStorage.getItem(`user_${currentUser}_files`) || '{}');
                const item = files[path];
                if (!item || !item.data) {
                    showError('File not found');
                    return;
                }
                const a = document.createElement('a');
                a.href = item.data;
                a.download = name;
                a.click();
            } catch (error) {
                console.error('Error downloading file:', error.name, error.message);
                showError('Error downloading file: ' + error.message);
            }
        }

        function deleteItem(path) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                let files = JSON.parse(localStorage.getItem(`user_${currentUser}_files`) || '{}');
                if (path.endsWith('/')) {
                    // Delete folder and its contents
                    Object.keys(files).forEach(key => {
                        if (key.startsWith(path)) {
                            delete files[key];
                        }
                    });
                } else {
                    // Delete single file
                    delete files[path];
                }
                localStorage.setItem(`user_${currentUser}_files`, JSON.stringify(files));
                listFiles();
            } catch (error) {
                console.error('Error deleting item:', error.name, error.message);
                if (error.name === 'QuotaExceededError') {
                    showError('Storage quota exceeded. Please clear some data and try again.');
                } else {
                    showError('Error deleting item: ' + error.message);
                }
            }
        }

        function listFiles() {
            updatePathDisplay();
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            if (!isLoggedIn) {
                list.innerHTML = '<p class="text-center text-gray-500 text-base">Please log in to view files.</p>';
                return;
            }

            const breadcrumb = document.createElement('div');
            breadcrumb.className = 'breadcrumb flex items-center gap-2 mb-4 text-sm text-gray-500';
            const displayParts = currentPath.replace(`/${currentUser}/`, '/').split('/').filter(p => p);
            let cumulativePath = `/${currentUser}/`;
            const rootSpan = document.createElement('span');
            rootSpan.textContent = 'Root';
            rootSpan.className = 'cursor-pointer hover:text-blue-600';
            rootSpan.onclick = () => { currentPath = `/${currentUser}/`; listFiles(); };
            breadcrumb.appendChild(rootSpan);
            displayParts.forEach((part, index) => {
                cumulativePath += part + '/';
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                breadcrumb.appendChild(separator);
                const partSpan = document.createElement('span');
                partSpan.textContent = part;
                partSpan.className = 'cursor-pointer hover:text-blue-600';
                partSpan.onclick = ((path) => () => { currentPath = path; listFiles(); })(cumulativePath);
                breadcrumb.appendChild(partSpan);
            });
            list.appendChild(breadcrumb);

            if (displayParts.length > 0) {
                const backDiv = document.createElement('div');
                backDiv.className = 'file-item bg-gray-100 rounded-lg p-4 cursor-pointer flex items-center hover:bg-gray-200 transition-all';
                backDiv.innerHTML = `
                    <svg class="w-6 h-6 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    <span class="text-base font-semibold">Back to Parent</span>
                `;
                backDiv.onclick = function() {
                    const fullParts = currentPath.split('/').filter(p => p);
                    fullParts.pop();
                    currentPath = fullParts.length > 0 ? '/' + fullParts.join('/') + '/' : `/${currentUser}/`;
                    listFiles();
                };
                list.appendChild(backDiv);
            }

            try {
                const files = JSON.parse(localStorage.getItem(`user_${currentUser}_files`) || '{}');
                const items = Object.values(files).filter(item => item.folder === currentPath);
                items.forEach(item => {
                    const relativeName = item.path.substring(currentPath.length);
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'file-item bg-white rounded-lg shadow-md p-4 cursor-pointer relative';
                    let content = '';
                    if (item.type === 'directory') {
                        content = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                    </svg>
                                    <span class="font-semibold text-base">${relativeName.slice(0, -1)}</span>
                                </div>
                                <button onclick="event.stopPropagation(); deleteItem('${item.path}')" class="text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        `;
                        itemDiv.onclick = function(e) {
                            currentPath = item.path;
                            listFiles();
                        };
                    } else {
                        const fileSize = item.size ? formatFileSize(item.size) : 'Unknown';
                        content = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                    </svg>
                                    <div>
                                        <span class="font-semibold text-base">${relativeName}</span>
                                        <p class="text-sm text-gray-500">${fileSize}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); downloadFile('${item.path}', '${relativeName}')" class="text-green-600 hover:text-green-700">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                        </svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteItem('${item.path}')" class="text-red-600 hover:text-red-800">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        `;
                        if (item.type.startsWith('image/')) {
                            const img = document.createElement('img');
                            img.src = item.data;
                            img.className = 'mt-2 rounded max-w-full h-auto';
                            img.style.maxHeight = '120px';
                            itemDiv.appendChild(img);
                        } else if (item.type.startsWith('video/')) {
                            const video = document.createElement('video');
                            video.src = item.data;
                            video.className = 'mt-2 rounded';
                            video.controls = true;
                            video.style.maxHeight = '120px';
                            itemDiv.appendChild(video);
                        }
                        itemDiv.onclick = function(e) {
                            if (!e.target.closest('button')) {
                                downloadFile(item.path, relativeName);
                            }
                        };
                    }
                    itemDiv.innerHTML = content;
                    list.appendChild(itemDiv);
                });
            } catch (error) {
                console.error('Error listing files:', error.name, error.message);
                showError('Error listing files: ' + error.message);
            }
        }

        // Initialize input validation and touch events
        document.addEventListener('DOMContentLoaded', () => {
            setupInputValidation();
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    button.click();
                }, { passive: false });
            });
            checkAuthState();
            listFiles();
        });
    </script>
</body>
</html>